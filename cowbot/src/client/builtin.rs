use super::cowfiles::CowfileDescriptor;
use anyhow::{anyhow, Result};
use base64::Engine;
use cowparse::ImageBuilder;
use image::ImageFormat;
use std::io::Cursor;

const FONT: &[u8; 2063520] =
    include_bytes!("../../../assets/font/JetBrainsMonoNerdFont-Regular.ttf");
const FONT_BOLD: &[u8; 2067288] =
    include_bytes!("../../../assets/font/JetBrainsMonoNerdFont-Bold.ttf");
const WIDTH: usize = 80;

struct BuiltinCowfile {
    pub id: String,
    pub data: String,
}

fn get_builtin_data() -> Vec<BuiltinCowfile> {
    let cow = BuiltinCowfile {
        id: String::from("d4930f4c-9320-4162-8d52-8cf628afa904"),
        data: String::from("IyBDb3cKIyBieSBVbmtub3duCgokeCA9ICJcZVs0OW0gICI7ICAgICAgICAgICNyZXNldCBjb2xvcgokdCA9ICIkdGhvdWdodHMiOwokYSA9ICJcZVs0ODs1OzIzNW0gICI7CiRiID0gIlxlWzQ4OzU7MjIzbSAgIjsKJGMgPSAiXGVbNDg7NTsyMzFtICAiOwoKJHRoZV9jaGFyYSA9IDw8RU9DCiAgICAgICAkdCAgICAgICAgICAgICAgICAgICAgICRhJHgKICAgICAgICAkdCAgICAgICAgICAgICAgICAgICRhJGIkYSR4ICAgICAgJGEgICR4CiAgICAgICAgICR0ICAgICAkYSR4ICAgICAgICAkYSRiICAkYSR4ICAkYSRjICAkYSR4CiAgICAgICAgICAkdCAgJGEkYiRhJHggICAgICAkYSRiICAkYSR4JGEkYyAgJGEkeCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhICAkeAogICAgICAgICAgICAgICRhJGIkYSR4ICAkYSAgICAgICAgICAgICAgJGMgICRhJHggICAgICAgICAgICAgICAgICAgICAgICAgICAgJGEkYyAgJGEkeAogICAgICAgICAgICAgICRhJGIkYSAgICAkYyRhICAgICAgICAgICAgICAgICR4ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGEkYyAgICAkYSR4CiAgICAgICAgICAgICAgJGEgICAgJGMgICAgJGEgICAgICAgICAgICAgICAgJHggICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhJGMkYSR4CiAgICAgICAgJGEgICAgICAkYyAgICAgICAgICAgICRhICAgICAgICAgICRjJGEgICAgICAgICAgICAgICAgICAgICAgICAkeCAgICAgICAgJGEkeAogICAgICAkYSRjICAgICAgICAgICAgICAgICAgICAgICRhICAgICAgICAgICRjJGEgICAgICAgICAgICAgICAgICAgICAgICAkeCAgICAgICRhJHgKICAgICAgJGEkYyAgJGEgICRjICAgICAgICAgICAgICAgICAgICAgICAgJGEkYyAgJGEgICAgICAgICAgICAgICAgICAgICAgICAkeCAgICAkYSR4CiAgICAgICAgJGEkYyRhICAkYyAgICAgICAgICAgICAgICAkYSAgJGMgICAgJGEkYyRhICAgICAgICAgICAgICAgICAgICAgICAgICAkeCAgJGEkeAogICAgICAgICAgJGEkeCAgJGEkYyAgICAgICAgICAgICAgJGEgICRjICAgICRhJGMkYSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR4CiAgICAgICAgICAgICAgICAkYSRjICAkYSAgJGMgICAgICAgICAgICAgICAgJGEkYyRhICAgICAgICAgICAgICAgICAgICAgICAgJGMkYSR4CiAgICAgICAgICAgICAgICAgICRhJGMkYSAgJGMgICAgICAgICRhICAgICRjJGEkYyRhICAgICAgICAgICRjJGEgICAgICAgICAgJGMkYSR4CiAgICAgICAgICAgICAgICAgICRhJGMgICAgICAgICRhICAgICRiICAgICRhICAkYyAgJGEgICAgICAkYyAgICAkYSAgICAgICRjICAkYSR4CiAgICAgICAgICAgICAgICAgICRhJGMgICAgJGEgICRiICAgICAgICAgICAgJGEkYyAgICAkYSAgJGMgICAgICAgICRhICAkYyAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgJGEkYyRhJGIgICAgICAgICRhICAkYiAgJGEkYyAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgJGEgICRiICAgICAgICAgICAgICAgICRhJGMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgICAkYSRiICAkYSAgJGIgICAgICAkYSRjICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgICAgICRhJGIgICAgICAkYSAgICAkYyAgICAgICAgICAgICAgICAgICRhJGMgICAgICAgICAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGEgICAgICAkYyAgICAgICRhJGMgICAgICAgICAgICAgICRhJGMgICAgICAgICAgJGEkeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhJGMgICRhICAgICRjICAgICRhICAgICAgICAgICAgJGMgICAgICAgICRhJHgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYSRjICAkYSR4JGEkYyAgICAkYSR4ICAkYSRjICAkYSRjICAgICAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGEkYyRhJHggICRhJGMgICRhJHggICAgJGEkYyAgJGEgICRjICAgICRhJHgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGEgICAgICAkeCRhICAgICRjJGEkeCAgICAkYSAgICAgICR4JGEgICAgICAkeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYSAgICAkeCAgJGEgICAgICAkeCAgICAgICRhICAgICR4ICAkYSAgICAkeApFT0M="),
    };

    let kitten = BuiltinCowfile {
        id: String::from("86cc30b9-9e5a-4c76-89e1-d603cdd17a2a"),
        data: String::from("IyBLaXR0ZW4KIyBieSBVbmtub3duCgokeCA9ICJcZVs0OW0gICI7ICAgICAgICAgICNyZXNldCBjb2xvcgokdCA9ICIkdGhvdWdodHMiOwokYSA9ICJcZVs0ODs1OzIzNG0gICI7CiRiID0gIlxlWzQ4OzU7MjM4bSAgIjsKJGMgPSAiXGVbNDg7NTsyNDdtICAiOwokZCA9ICJcZVs0ODs1OzIxOG0gICI7CiRlID0gIlxlWzQ4OzU7MjMxbSAgIjsKCiR0aGVfY2hhcmEgPSA8PEVPQwogICAgICAgICAgICAgICAgICAgICAgICAkdAogICAgICAgICAgICAgICAgICAgICAgICAgJHQgICAgICAgICAgICAgICAgICAgICAgICAgJGEgICR4CiAgICAgICAgICAgICAgICAgICAgICAgICAgJHQgICAgICAgICAgICAgICAgICAgICAgJGEkYiAgJGEkeAogICAgICAgICAgICAgICAgICAgICAgICAgICAkdCAgICAgICAgICAgICAgICAgICAkYSAgICAkYiRhJHgKICAgICAgICAgICRhICAgICR4ICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhICAgICAgJGIgICRhJHgKICAgICAgICAkYSRjICAgICRhICAgICAgICAgICR4ICAgICAgICAkYSAgICAgICAgICAgICAgJGIgICRhJHgKICAgICAgICAkYSRjICAgICRhICAkYiAgICAgICRhICAgICAgICAkYiAgICAgICAgJGEgICAgICAkYiRhJHgKICAgICAgJGEkYyRiJGMgICRhICAkYiRhICAkYiAgICAgICRjJGIgICAgICAkYyRiICAgICRhICAkYiRhJHgKICAgICAgJGEkYyAgJGIkYSAgICAkYiRhICAgICAgJGIgICAgJGMkYiAgJGMgICAgJGIkYyRiJGEgICAgJHgKICAgICRhJGIkYyAgICAkYSR4JGEgICRkICAkYSAgICAkYiAgJGMgICRiICAkYyAgJGIkYyAgJGIkYSAgJHgKICAgICRhJGMkYiAgJGEkeCAgJGEgICRkICAgICRhICAgICRiJGMgICAgJGIkYyAgICAgICAgICAkYSAgJHgKICAgICRhJGIkYyAgJGEkeCAgJGEgICRkICAgICAgJGEgICRjICAgICAgICAgICAgICAgICAgJGEgICAgJHgKICAgICRhJGMkYiAgJGEkeCAgICAkYSAgJGQgICAgJGEgICRjICAgICAgICAgICAgICAgICRhICAgICAgJHgKICAgICRhJGIkYyAgJGEkeCAgICAkYSAgICAkZCRhICAgICRjICAgICAgICAgICAgICAgICRhICAkYyRhJHgKICAgICRhJGIgICAgJGEkeCAgICAgICRhICAgICAgJGMgICAgJGIkYSAgJGMgICAgICAgICRlJGEkZSRhJHgKICAgICRhJGIkYyAgICAkYSR4ICAgICRhICAkYiAgJGMgICRiJGEgICAgICAkYyRlICAkYyRhICAkZSRhICAgICR4CiAgICAkYSRjICAkYiAgICAkYSAgICAgICRiICAkYyAgICAkYSRjJGEgICAgJGMkZSAgICAkYiAgJGUgICRiJHgKICAgICAgJGEkYiAgICAkYSAgJGMkYiRhJGMgICAgICAkZSRjJGUgICRhICAkYyRlICAgICAgICAkYiRhICAgICR4CiAgICAgICRhJGIgICRhJGIgICAgJGMkYSRiICAgICRjJGUgICAgJGEgICAgJGUgICRjICAkZSAgICAkYiR4CiAgICAgICAgJGEgICRiICAgICRjICAkYSRiJGMgICRhICAkYyRlJGIgICRlICAgICRhICAkZSAgJGMkYiR4CiAgICAgICAgJGEkYyRiICAkYyAgJGIkYyAgICAgICRlICAgICAgICAgICAgICAgICAgICAgICRjJGIkeAogICAgICAkYSRiJGMkYiRjICAkYiAgJGMgICAgICAkYiRhICAkYiRlICAgICAgICAgICAgJGMkYiR4CiAgICAgICRhJGIkYyAgICAgICRiICAkYyAgICAgICAgJGIgICRlICAgICAgICAgICRiICAgICR4CiAgICAgICRhJGIkYyAgICAgICRiJGMgICAgJGIkYyAgICAgICAgICAgICAgICAkYiRhJHgKICAgICAgJGEkYiAgJGMgICAgJGIkYyAgICAkYiRjJGIgICRjICAgICRlJGMkYiAgJGMkYSR4CiAgICAkYSRiICAgICRjICAgICRiJGMgICAgICAgICRiICAgICAgJGUgICRiJGMgICAgJGIkYSR4CiAgICAkYSRiICAgICAgJGMgICRlICAgICRjICAgICAgJGIgICRhJGUkYyRhJGUgICAgICAkYiRhJHgKICAgICRhJGMkYiRjICAgICAgJGUgICAgICAkYyAgICAgICAgJGEgICAgICAkZSAgICAgICAgJGEkeAogICAgJGEkZSRjICAgICAgJGUgICRjJGEgICAgJGUkYyRlJGMkZSRhJHggICRhJGUgICRjJGUkYSR4CiAgICAkYSRlICAgICAgJGMkYSAgICAkeCAgICAkYSRlICAgICAgJGMkYSR4JGEkYyAgJGUgICRhJHgKICAgICRhJGUgICAgICAkYSAgICAgICR4ICAgICRhJGMkZSAgICAgICRhJHggICRhICAgICAgJHgKICAgICRhJGUgICAgJGEkeCAgICAgICAgICAgICAgJGEkZSRjICAkZSRhJHgKICAgICAgJGEgICAgJHggICAgICAgICAgICAgICAgJGEkYyAgJGUkYSR4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGEgICAgJHgKRU9D"),
    };

    let ferris = BuiltinCowfile {
        id: String::from("0b8b6c62-7da5-495a-8835-ff1e4b1347c3"),
        data: String::from("IyBGZXJyaXMgKE1hc2NvdCBvZiBSdXN0IFByb2dyYW1taW5nIExhbmd1YWdlKQojIGJ5IHUveW5ndG9kZCAtIGh0dHBzOi8vd3d3LnJlZGRpdC5jb20vci9ydXN0L2NvbW1lbnRzL2I5bWRsbC9waXhlbF9mZXJyaXNfMzJ4MzIvCgokeCA9ICJcZVs0OW0gICI7ICAgICAgICAgICNyZXNldCBjb2xvcgokdCA9ICIkdGhvdWdodHMiOwokYSA9ICJcZVs0ODs1OzIzM20gICI7CiRiID0gIlxlWzQ4OzU7MjA4bSAgIjsKJGMgPSAiXGVbNDg7NTsxNjZtICAiOwokZCA9ICJcZVs0ODs1OzE3M20gICI7CiRlID0gIlxlWzQ4OzU7MjMxbSAgIjsKJGYgPSAiXGVbNDg7NTsxMjVtICAiOwoKJHRoZV9jaGFyYSA9IDw8RU9DCiAgICAgICAgICAgJHQKICAgICAgICAgICAgJHQgICAgICAgICAgJGEkeCAgICAgICAgJGEkeAogICAgICAgICAgICAgJHQgICAgICAgJGEkYiRhJHggICAgJGEkYiRhJHgKICAgICAgICAgICAgICAkdCAgICAkYSRjJGQkYyRhJHgkYSRjJGQkYyRhJHgKICAgICAgICAgICAgJGEgICAgICAkYyRiJGMkYiRjJGEkYyRiJGMkYiRjJGEgICAgICAkeAogICAgICAgICAgICAkYSRiJGMkYiRkJGMkZCRjICAgICAgICAkZCRjJGQkYiRjJGIkYSR4CiAgICAgICAgICAgICRhJGMkYiRjJGQgICRjJGQgICAgICAgICRjJGQgICRjJGIkYyRhJHgKICAgICRhICAgICAgICAkYiRjJGQkYyRkICAgICAgICAgICAgICAgICRjJGQkYyRiJGEgICAgICAgICR4CiAgICAkZCRjICAkYSRjICAkZCRjJGQgICAgICAgICAgICAgICAgICAgICRjJGQkYyAgJGEkYyAgJGQkeAogICAgJGEkZCAgJGMkYSRkICAgICRhICAkZSAgJGQgICAgJGUgICRhICAkZCAgICAkYSRjJGQgICRhJHgKJGQkYSR4JGEkZCAgJGEkYyRkICAkYSAgJGUgICRkICAgICRlICAkYSAgJGQgICRjJGEkZCAgJGEkeCRhJGQkYSR4CiRkICAkYSAgJGQkYyRhJGQgICAgJGEgICAgICAkZCAgICAkYSAgICAgICRkICAgICRhJGMkZCRhICAkZCAgJGEkeAokYyRkICAgICAgICAkYyRhJGQgICRhICAgICAgJGQgICAgJGEgICAgICAkZCAgJGEkYyRkICAgICAgICAkYyRhJHgKJGEkYyAgICAkZCAgICAkYyRhJGQgICAgICAgICAgICAgICAgICAgICAgICAkYSRjJGQgICAgJGMgICAgJGEkeAogICRhICAgICRkJGMkZCAgJGMkYSRkICAgICAgJGEgICAgJGQgICAgICAkYSRjJGQgICRjJGQkYSAgICAkeAogICAgJGEkYyRhICAkYyRkICAgICAgICAgICAgJGEgICAgJGQgICAgICAgICAgICAkYyRhICAkYyRhJHgKICAgICRhJGMgICRhJGMkZCRjJGQkYyRkICAgICRmICAgICRkICAgICRjJGQkYyRkJGMkYSRjICAkYSR4CiAgJGEkYyAgICAkYSAgJGMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhICAkYyAgICAkYSR4CiAgJGEkYyAgJGEgICR4JGEgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR4JGEgICRjICAkYSR4CiAgJGEgICAgICAkeCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYSAgICAgICR4CkVPQw=="),
    };

    let piplup = BuiltinCowfile {
        id: String::from("5b5323e8-4d1b-44ba-9be5-e9c4759a5f54"),
        data: String::from("IyBQaXBsdXAgKFBva2Vtb24pCiMgYnkgUG9rZW1vbkRCIC0gaHR0cHM6Ly9pbWcucG9rZW1vbmRiLm5ldC9zcHJpdGVzL3N3b3JkLXNoaWVsZC9pY29uL3BpcGx1cC5wbmcKCiR4ID0gIlxlWzQ5bSAgIjsgICAgICAgICAgI3Jlc2V0IGNvbG9yCiR0ID0gIiR0aG91Z2h0cyI7CiRhID0gIlxlWzQ4OzU7MjM2bSAgIjsKJGIgPSAiXGVbNDg7NTs2Mm0gICI7CiRjID0gIlxlWzQ4OzU7NjltICAiOwokZCA9ICJcZVs0ODs1OzExN20gICI7CiRlID0gIlxlWzQ4OzU7MjMxbSAgIjsKJGYgPSAiXGVbNDg7NTsyNDNtICAiOwokZyA9ICJcZVs0ODs1OzIyNm0gICI7CiRoID0gIlxlWzQ4OzU7MTc4bSAgIjsKJGkgPSAiXGVbNDg7NTsyNTBtICAiOwokaiA9ICJcZVs0ODs1OzIzOW0gICI7CiRrID0gIlxlWzQ4OzU7NzRtICAiOwokbCA9ICJcZVs0ODs1OzY3bSAgIjsKCiR0aGVfY2hhcmEgPSA8PEVPQwogICR0CiAgICR0ICAgICAgICRhICAgICAgJHgKICAgICR0ICAkYSAgJGIkYyAgJGIkYSAgJHgKICAgICAgJGEkYiRjICAgICAgICAgICRiJGEkeAogICAgICAkYSRjICAgICAgICAgICAgICAkYSR4CiAgICAkYSRiJGMgICAgICAgICAgICAgICRiJGEkeAogICAgJGEkYyRkJGMgICAgJGUgICRjICAgICRhJHgKICAgICRhJGQgICAgICAkZSAgICAgICRjICAkYSR4CiAgICAgICRhJGYkZCRlICAkYSRlICAkYyRhJHgKICAgICRhJGcgICRmJGUgICRiJGUgICRiJGEkeAogICAgICAkYSRoICAkaSRlICAkaSRqJGEkeAogICAgICAgICRhJGokaSAgICAkaiAgJGIkYSAgJHgKICAgICAgJGEkaiRiICAgICAgJGMgICRqJGIkaiRhJHgKICAgICAgJGEkayRqJGIkaiRjICAkaiRkJGokYiRhJHgKICAgICRhJGskYSAgJGokZCRqICAkZCAgICAkaiRhJHgKICAgICRhICAkeCRhJGUkZCRlJGokZCAgICAkYSR4CiAgICAgICAgICAgICRhJGwkZCAgJGokZCRqJGEkeAogICAgICAgICAgJGEkaCAgJGEkbCRrJGokayRhJHgKICAgICAgICAgICAgJGEgICR4JGEkZyAgJGEkeAogICAgICAgICAgICAgICAgICAgICRhICAkeApFT0M="),
    };

    let psyduck = BuiltinCowfile {
        id: String::from("b904542b-696d-450d-b2af-3c6e127317d2"),
        data: String::from("IyBQc3lkdWNrIChQb2tlbW9uKQojIGJ5IEJ1bGJhcGVkaWEgLSBodHRwczovL2J1bGJhcGVkaWEuYnVsYmFnYXJkZW4ubmV0L3dpa2kvTGlzdF9vZl9Qb2slQzMlQTltb25fYnlfS2FudG9fUG9rJUMzJUE5ZGV4X251bWJlcgoKJHggPSAiXGVbNDltICAiOyAgICAgICAgICAjcmVzZXQgY29sb3IKJHQgPSAiJHRob3VnaHRzIjsKJGEgPSAiXGVbNDg7NTsyMjFtICAiOwokYiA9ICJcZVs0ODs1OzIzOG0gICI7CiRjID0gIlxlWzQ4OzU7MTQzbSAgIjsKJGQgPSAiXGVbNDg7NTsxMzdtICAiOwokZSA9ICJcZVs0ODs1OzIzMW0gICI7CiRmID0gIlxlWzQ4OzU7MjIzbSAgIjsKJGcgPSAiXGVbNDg7NTsxODVtICAiOwoKJHRoZV9jaGFyYSA9IDw8RU9DCiAgICAgICAgJHQKICAgICAgICAgJHQKICAgICAgICAgICR0CiAgICAgICAgJGEgICAgJHgKICAgICAgJGEgICRiICAkYSAgICAgICR4CiAgICAkYyAgJGIkYSAgICAgICAgICAgICAgJHgKICAgICRjJGQkZSRhICAgICAgJGMgICRhICAgICR4CiAgICAkYyRlJHgkYSAgICAkYyRlICAkYyRhJGIkYSRiJHgKICAgICAgJGQkZSRiICAkYSRlJHgkZSAgJGIkYSRjJGEkeAogICAgICAkYyRiJGYgICRiICAkZSAgJGQkYiRhICAgICR4CiAgICAgICRiJGYgICRjJGYgICRiJGQkYyAgJGEgICAgICAkeAogICAgJGckZiAgICAgICAgJGcgICRiJGMkYiRhICAgICAgJHgKICAgICRmICAgICAgJGcgICRiICAgICAgJGMgICRhICAkeAogICAgICAkZyAgICAgICRiJGMgICAgICAgICAgICAkeAogICAgICAgICRiICAgICRhICAgICRjICAgICAgICAkYiR4CiAgICAgICAgJGMkYSAgICAgICAgICAkYyAgICAgICRiJGMgICR4CiAgICAkZyAgJGIkYyRhICAgICAgJGMgICAgICAkYiRjICAkeAogICAgICAkZyAgJGIgICRjICAgICAgICAkYiAgICAkeAogICAgICAgICAgJGMgICR4JGIgICAgICAkYyRnJHgKICAgICAgICAgICAgICAgICAgJGMkZyRjJGckeApFT0M="),
    };

    let nook = BuiltinCowfile {
        id: String::from("13cd1655-c80b-4bcc-94c7-422b19c1c6ec"),
        data: String::from("IyBUb20gTm9vayAoQW5pbWFsIENyb3NzaW5nKQojIGJ5IC91L21pc3N0YXBrYXQ1IC0gaHR0cHM6Ly93d3cucmVkZGl0LmNvbS9yL0FuaW1hbENyb3NzaW5nL2NvbW1lbnRzL2Z0b2liZC9pX21hZGVfYV9waXhlbF9hY25oX3RvbV9ub29rX291dF9vZl9sZWdvLwojIEdlbmVyYXRlZCB3aXRoIENoYXJjMGFsJ3MgY293c2F5IGZpbGUgY29udmVydGVyIGh0dHA6Ly9jaGFyYzBhbC5naXRodWIuaW8vY293c2F5LWZpbGVzL2NvbnZlcnRlcgoKJHggPSAiXGVbNDltICAiOyAgICAgICAgICAjcmVzZXQgY29sb3IKJHQgPSAiJHRob3VnaHRzICI7CiRhID0gIlxlWzQ4OzU7MjM1bSAgIjsKJGIgPSAiXGVbNDg7NTsxMzdtICAiOwokYyA9ICJcZVs0ODs1OzIyNW0gICI7CiRkID0gIlxlWzQ4OzU7MjM1bSAgIjsKJGUgPSAiXGVbNDg7NTsxOW0gICI7CiRmID0gIlxlWzQ4OzU7MjU1bSAgIjsKJGcgPSAiXGVbNDg7NTszMG0gICI7CiRoID0gIlxlWzQ4OzU7MTg3bSAgIjsKJGkgPSAiXGVbNDg7NTs5NG0gICI7CiRqID0gIlxlWzQ4OzU7MjA4bSAgIjsKJGsgPSAiXGVbNDg7NTsxMDFtICAiOwoKJHRoZV9jb3cgPSA8PEVPQwogICAgICAgICAgJHQKICAgICAgICAgICAgJHQKICAgICAgICAgICAgICAgICRhICAgICR4ICAgICAgICAgICAgICAgICAgICAkYSAgICAkeAogICAgICAgICAgICAgICRhJGIgICRhICAkeCAgICAgICAgICAgICAgICAkYSAgJGIgICRhJHgKICAgICAgICAgICAgJGEkYiRjICAkYiRhJHggICAgICAgICAgICAgICAgJGEkYiRjICAkYiRhJHgKICAgICAgICAgICAgJGEkYiRjICAkYiRhICAgICAgICAgICAgICAgICAgICAkYiRjICAkYiRhJHgKICAgICAgICAgICAgICAkYSRiJGEgICRiICAgICAgICAgICAgICAgICAgICAkYSAgJGIkYSR4CiAgICAgICAgICAgICAgICAkYSRiICAkZCAgICAgICAgICAgICAgICAgICAgJGIgICRhJHgKICAgICAgICAgICAgICAkYSRiJGQgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGIkYSR4CiAgICAgICAgICAgICRhJGIkZCAgJGIgICRkICAgICAgICAgICAgICAgICRiICAkZCAgJGIkYSR4CiAgICAgICAgICAgICRhJGIkZCRiICAgICAgJGQgICAgICAgICAgICAkYiAgICAgICRkJGIkYSR4CiAgICAgICAgICAkYSRiJGQgICRiICAkZSRmJGQgICAgICAgICAgICAkZiRlJGIgICRkICAkYiRhJHgKICAgICAgICAgICRhJGIkZCAgJGYkZSAgJGYkZCAgICAgICAgICAgICRmJGUgICRmJGQgICRiJGEkeAogICAgICAgICAgJGEkYiRkICAkZiRlICAkZiRkICAgICAgICAgICAgJGYkZSAgJGYkZCAgJGIkYSR4CiAgICAgICAgICAkYSRiJGQgICAgJGYgICRkICAgICRiICAgICRkICAgICRmICAkZCAgICAkYiRhJHgKICAgICAgICAgICRhJGIkZCAgICAgICAgICAkYiAgICAgICAgICAgICRkICAgICAgICAkYiAgJGEkeAogICAgICAgICAgJGEkYiAgICAkZCAgICAkYiAgICAkYSAgICAkYiAgICAkZCAgICAkYiAgICAkYSR4CiAgICAgICAgICAgICRhJGIgICAgICAgICAgICAkYSAgICAgICAgJGIgICAgICAgICAgICAkYSR4CiAgICAgICAgICAgICRhJGIgICAgICAgICAgICAkYSAgICAgICAgJGIgICAgICAgICAgICAkYSR4CiAgICAgICAgICAgICAgJGEkYiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGEgICR4CiAgICAgICAgICAgICAgICAkYSAgJGIgICAgICAgICAgICAgICAgICAgICAgICAkYSAgICAkeAogICAgICAgICAgICAgICAgICAgICRhICAgICAgICAgICAgICAgICAgICAgICAgICAgICR4CiAgICAgICAgICAgICAgICAgICAgICAkYSAgJGckaCRiICAgICRoJGcgICRhICAkeCAgJGEgICR4CiAgICAgICAgICAgICAgICAgICAgJGEkaCAgICAgICAgJGIkaCAgJGcgICAgJGgkYSAgJGkgICRhJHgKICAgICAgICAgICAgICAgICAgJGEkaCRnJGggICRnJGggICRnJGggICAgJGEkaCAgJGIkaSAgJGEkeAogICAgICAgICAgICAgICAgJGEkZyRoJGEkZyAgJGggICRpJGgkZyAgJGgkZyRhJGckYiAgICAkYSR4CiAgICAgICAgICAgICAgJGEkYiRoICAkYSRnICAkaCRnJGggICRnJGogICRoJGEkaCRiICAkYSR4CiAgICAgICAgICAgICRhJGIgICAgJGEkaCAgICAgICAgJGkkaCAgJGogICRoJGckYSAgICAkeAogICAgICAgICAgJGEkaSAgJGIkYSAgJGckaCAgJGcgICRoJGckaCAgJGcgICRoJGEkeAogICAgICAgICAgJGEkaSAgJGEkeCRhJGckaCAgJGcgICRpJGggICAgJGcgICRoJGEgICAgICAkeAogICAgICAgICAgICAkYSAgJHggICRhJGgkZyRoICAgICAgICAkZyRoICAgICAgJGEkaSAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgJGEkayAgICAgICAgICAgICAgICAgICAgICAkYSRpICAgICAgJGEkeAogICAgICAgICAgICAgICAgICAgICRhJGsgICAgICAgICAgICAgICAgICAgICAgJGEkaSAgICAgICRhJHgKICAgICAgICAgICAgICAgICAgICAkYSRrICAgICAgICAkYSAgJGsgICAgICAgICRhJGkgICAgJGEkeAogICAgICAgICAgICAgICAgICAgICAgJGEkayAgICAgICRhICAkayAgICAgICRhICAgICAgICAkeAogICAgICAgICAgICAgICAgICAgICAgICAkYSRiICAkYSR4ICAkYSRiICAkYSR4CiAgICAgICAgICAgICAgICAgICAgICAgICRhJGkgICRhJHggICRhJGkgICRhJHgKICAgICAgICAgICAgICAgICAgICAgICAgICAkYSAgJHggICAgICAkYSAgJHgKRU9D"),
    };

    let eevee = BuiltinCowfile {
        id: String::from("582f1bd2-2f1b-4c2c-8ed2-6a8ebc073cdb"),
        data: String::from("IyBFZXZlZSAoUG9rZW1vbikKIyBieSBCdWxiYXBlZGlhIC0gaHR0cHM6Ly9idWxiYXBlZGlhLmJ1bGJhZ2FyZGVuLm5ldC93aWtpL0xpc3Rfb2ZfUG9rJUMzJUE5bW9uX2J5X0thbnRvX1BvayVDMyVBOWRleF9udW1iZXIKCiR4ID0gIlxlWzQ5bSAgIjsgICAgICAgICAgI3Jlc2V0IGNvbG9yCiR0ID0gIiR0aG91Z2h0cyI7CiRhID0gIlxlWzQ4OzU7MTc5bSAgIjsKJGIgPSAiXGVbNDg7NTsyNDBtICAiOwokYyA9ICJcZVs0ODs1OzEzN20gICI7CiRkID0gIlxlWzQ4OzU7MTg1bSAgIjsKJGUgPSAiXGVbNDg7NTsyMzBtICAiOwokZiA9ICJcZVs0ODs1OzIzOG0gICI7CiRnID0gIlxlWzQ4OzU7MjMxbSAgIjsKCiR0aGVfY2hhcmEgPSA8PEVPQwogICR0CiAgICR0CiAgICAkdCAgICAkYSAgJHgKICAgICAkdCAkYSRiJGEkeCAgCiAgICAgICAgJGEkYiRjJHggICAgICAgICRkICAkeCAgICAkZSR4CiAgICAgICAgJGIkZiAgJGQkeCAgJGMkZCRiJGEkZiRjJGUgICR4CiAgICAgICAgJGYkYSRkJGEkZCRiJGEkYiAgJGEkZiRjJGQkZSR4CiAgICAgICRiJGEgICAgICAgICAgJGIgICRhJGYkYyAgICAkZCR4CiAgICAgICRnJGEgICAgICAgICAgJGMkYSRmJGIkYyAgICAkeAogICAgICAgICRhICAgICRjJGIkYSAgJGYkYiRjJGIkeAogICAgICAkYSAgICAgICRnJHgkYSRiJGQkYiRjICAkeAogICAgICAgICRhICAgICRiJHgkYyRiJGQgICRiJGMkeAogICAgICAkZSRiICAkYyAgICAkYiRlJGQgICRiJGMgICR4CiAgICAgICRlICAgICAgICAkZCRlICAkZCRmJGIkYyAgJHgKICAgICAgICAkZSRkJGUgICRkJGUkZCRiJHggICRiJGMkeAogICAgICAgICAgJGYkZCAgJGUkYiRjJHgKICAgICAgICAgICAgJGMkZiAgJGMkeAogICAgICAgICAgICAgICAgJGEkYyR4CkVPQw=="),
    };

    let hitman = BuiltinCowfile {
        id: String::from("4a4bef4b-ad12-4ebd-afce-d889de1aefb9"),
        data: String::from("IyBBZ2VudCA0NyAoSGl0bWFuIHNlcmllcykKIyBieSBGRFpHYW1lciAtIGh0dHBzOi8vd3d3LnJlZGRpdC5jb20vci9IaVRNQU4vY29tbWVudHMvY2pxdjMyL3BpeGVsX2FydF9ieV90d2l0Y2h0dmZkemdhbWVyLwojIEdlbmVyYXRlZCB3aXRoIENoYXJjMGFsJ3MgY293c2F5IGZpbGUgY29udmVydGVyIGh0dHA6Ly9jaGFyYzBhbC5naXRodWIuaW8vY293c2F5LWZpbGVzL2NvbnZlcnRlcgoKJHggPSAiXGVbNDltICAiOyAgICAgICAgICAjcmVzZXQgY29sb3IKJHQgPSAiJHRob3VnaHRzICI7CiRhID0gIlxlWzQ4OzU7MjIzbSAgIjsKJGIgPSAiXGVbNDg7NTsxODBtICAiOwokYyA9ICJcZVs0ODs1Ozk1bSAgIjsKJGQgPSAiXGVbNDg7NTsyMzNtICAiOwokZSA9ICJcZVs0ODs1OzIzMW0gICI7CiRmID0gIlxlWzQ4OzU7MjM0bSAgIjsKJGcgPSAiXGVbNDg7NTsyMzVtICAiOwokaCA9ICJcZVs0ODs1OzI0OG0gICI7CiRpID0gIlxlWzQ4OzU7NTJtICAiOwokaiA9ICJcZVs0ODs1Ozg4bSAgIjsKJGsgPSAiXGVbNDg7NTsyNTJtICAiOwokbCA9ICJcZVs0ODs1OzEyNG0gICI7CiRtID0gIlxlWzQ4OzU7MjQzbSAgIjsKJG4gPSAiXGVbNDg7NTsyMzdtICAiOwokbyA9ICJcZVs0ODs1OzIzOW0gICI7CgokdGhlX2NvdyA9IDw8RU9DCiAgICAgICAgICAgICR0CiAgICAgICAgICAgICAgJHQgICAgICAgICAgICAgICRhICAgICAgJHgKICAgICAgICAgICAgICAgICR0ICAgICAgICAgICRhICAkYiAgJGEgICR4CiAgICAgICAgICAgICAgICAgICR0ICAgICAgICAkYSRiICAgICAgJGEkeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGEkYiAgICAgICRhJHgKICAgICAgICAgICAgICAgICAgICAgICAgICAkYyRhJGIgICAgICAkYSRiJHgKICAgICAgICAgICAgICAgICAgICAgICAgICAkYyRhJGIgICAgICAkYSRiJHgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjJGIgICAgICAkYSR4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYyAgJGIgICAgJGEkeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYyRiICAgICR4CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGQkZSRjICAgICAgJGUkZiAgJHgKICAgICAgICAgICAgICAgICAgICAgICAgJGQgICRlICAgICAgICAgICRkJGYkZyR4CiAgICAgICAgICAgICAgICAgICAgJGcgICRkICAkZSRoJGkkaiRoJGUkZCRmJGcgICAgJHgKICAgICAgICAgICAgICAgICAgJGckZiAgJGQgICRoJGUkaSRqJGUkaCRkICAkZiAgJGcgICR4CiAgICAgICAgICAgICAgICAkZyAgJGYkZCAgICAkZSAgJGkkaiRlICAkZCAgICAkZiAgJGckeAogICAgICAgICAgICAgICAgJGckZiAgJGQgICAgJGUgICRpICAkZSAgJGQgICAgICAkZiRnJHgKICAgICAgICAgICAgICAgICRnJGYkZCAgICAgICRlICAkaSAgJGUgICRkICAgICAgJGYkZyAgJHgKICAgICAgICAgICAgICAgICRnJGYkZCAgICAgICRlICAkaSAgJGUgICRkICAgICAgJGYgICRnJHgKICAgICAgICAgICAgICAgICRnJGYkZCAgICAgICRrJGUkaSAgJGUgICRkICAgICAgICAkZiRnJHgKICAgICAgICAgICAgICAgICRnJGYkZCAgICAgICRrJGUkaSRqJGUgICRkICAgICAgICAkZiRnJHgKICAgICAgICAgICAgICAgICRnJGYkZCAgICAgICRrJGUkaSRqJGUgICRkICAgICAgICAkZiRnJHgKICAgICAgICAgICAgICAgICRnJGYkZCAgICAgICRrJGUkaSRqJGUgICRkICAgICAgICAkZiRnJHgKICAgICAgICAgICAgICAgICRnJGYkZCAgICAkaCRrJGkkaiAgJGUgICRkICAgICR4JGQkZiAgJGckeAogICAgICAgICAgICAgICRnICAkZCAgICAgICRoJGskaSRqJGUgICAgJGQgICAgJHgkZCAgICAkZyR4CiAgICAgICAgICAgICAgJGckZCAgICAkaSRoJGsgICRpJGokZSAgICAkZCAgICAkeCAgJGQgICRnJHgKICAgICAgICAgICAgICAkZCAgJGkkaiRpJGgkayRpJGogICRlICAgICRkICAgICR4ICAkZCAgJGcgICR4CiAgICAgICAgICAgICRkICAkaSRsJGokaSRoJGskaiAgICAkZSAgICAkZCAgICAgICR4JGQgICAgJGckeAogICAgICAgICAgJGQgICRpJGwkaiAgJGkkayAgJGogICRlICAgICAgJGQgICAgICAkeCRkICAgICRnJHgKICAgICAgICAkZCAgJGkkbCAgJGogICRpJGsgICRqICAkZSAgICAgICRkICAgICAgJHgkZCAgICAkZyR4CiAgICAgICRkICAkaSRsICAkaiAgJGkgICRoJGsgICRlICAgICAgICAkZCAgICAgICR4ICAkZCAgICAgICR4CiAgICAgICRkJGkkaiRsICAkaiAgJGkkZCAgICAkaCAgJGsgICAgJGQgICAgICAgICAgJHgkZCAgICAgICR4CiAgICAgICRkJGkgICRqJGwkaiRpICAkZCAgICAgICAgICAgICAgICAgICAgICAgICAgJHgkZCAgICAgICR4CiAgICAgICRkICAgICRpJGokaSAgICAkZCAgICAgICAgICAgICAgICAgICAgICAgICAgJHggICRrJGUkayR4CiAgICAgICAgICAkZCRpICAgICAgJGQgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHggICRtJGQkbiR4CiAgICAgICAgICAkZCRpICAkZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHggICRtJGQkbiR4CiAgICAgICAgICAkZCAgICAgICRmJGQgICAgICAgICAgICAgICAgICAgICAgICAgICR4ICAgICRuJGQgICR4CiAgICAgICAgICAgICRtJGYgICAgJGQgICAgICAgICAgICAgICAgICAgICAgICAgICR4ICAgICAgJGQkeAogICAgICAgICAgICAkbSRuICAkZiRkICAgICAgICAgICAgICAgICAgICAkZiRkICAkeCAgJG0kZiRkJGYkeAogICAgICAgICAgICAkbSRuICAgICRkICAgICAgICAgICAgJHgkZCAgICAkZiRkICAkeCAgJG0kbyRmICAkZCR4CiAgICAgICAgICAgICRtJG4gICR4JGQgICAgICAgICAgICAkeCRkICAgICRmJGQgICR4ICAkbSRuJG8gICAgJHgKICAgICAgICAgICAgJG0kbiR4ICAkZCAgICAgICAgICAgICR4JGQgICAgJGYgICRkJHggICRtJG4kZCAgICAkeAogICAgICAgICAgICAkbSRuJHggICRkICAgICAgICAgICAgJHggICRkICAkZiAgJGQkeCAgJG0kbiRkICAgICR4CiAgICAgICAgICAgICRtJHggICAgJGQgICAgICAgICAgICAkeCAgJGQgICAgJGYkZCR4ICAkbSRuJGQgICAgJHgKICAgICAgICAgICAgJG0keCAgICAkZCAgICAgICAgICAgICR4ICAkZCAgICAkZiRkJHggICRtJG4kZCAgICAkeAogICAgICAgICAgICAkbSR4ICAgICAgJGQgICAgICAgICR4ICAgICRkICAgICAgICAkeCAgJG0kbiRkICAgICR4CiAgICAgICAgICAgICRtJHggICAgICAkZCAgICAgICAgJHggICAgICAkZCAgICAgICR4ICAkbSRuJGQgICAgJHgKICAgICAgICAgICAgJG0keCAgICAgICRmJGQgICAgICAkeCAgICAgICRkICAgICAgJHggICRtJG4kZCAgICAkeAogICAgICAgICAgICAgICAgICAgICAgJGYkZCAgICAgICR4ICAgICRmJGQgICAgICAkeCAgJG0kbiRkICAgICR4CkVPQw=="),
    };

    vec![cow, kitten, ferris, piplup, psyduck, nook, eevee, hitman]
}

fn get_builtin() -> Vec<CowfileDescriptor> {
    let cow = CowfileDescriptor {
        id: String::from("d4930f4c-9320-4162-8d52-8cf628afa904"),
        name: String::from("cow"),
        author: String::from("Unknown"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    let kitten = CowfileDescriptor {
        id: String::from("86cc30b9-9e5a-4c76-89e1-d603cdd17a2a"),
        name: String::from("kitten"),
        author: String::from("Unknown"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    let ferris = CowfileDescriptor {
        id: String::from("0b8b6c62-7da5-495a-8835-ff1e4b1347c3"),
        name: String::from("ferris"),
        author: String::from("u/yngtodd"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    let piplup = CowfileDescriptor {
        id: String::from("5b5323e8-4d1b-44ba-9be5-e9c4759a5f54"),
        name: String::from("piplup"),
        author: String::from("PokemonDB"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    let psyduck = CowfileDescriptor {
        id: String::from("b904542b-696d-450d-b2af-3c6e127317d2"),
        name: String::from("psyduck"),
        author: String::from("Bulbapedia"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    let nook = CowfileDescriptor {
        id: String::from("13cd1655-c80b-4bcc-94c7-422b19c1c6ec"),
        name: String::from("nook"),
        author: String::from("/u/misstapkat5"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    let eevee = CowfileDescriptor {
        id: String::from("582f1bd2-2f1b-4c2c-8ed2-6a8ebc073cdb"),
        name: String::from("eevee"),
        author: String::from("Bulbapedia"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    let hitman = CowfileDescriptor {
        id: String::from("4a4bef4b-ad12-4ebd-afce-d889de1aefb9"),
        name: String::from("hitman"),
        author: String::from("FDZGamer"),
        uploader_id: String::from("4296b6f6-88b5-436d-b8c8-1ffe745673fc"),
        server_id: None,
    };

    vec![cow, kitten, ferris, piplup, psyduck, nook, eevee, hitman]
}

fn decode_base64(data: &str) -> Result<String> {
    let decoded = base64::engine::general_purpose::STANDARD.decode(data)?;
    let decoded = String::from_utf8(decoded)?;
    Ok(decoded)
}

pub async fn get_cowfiles(_sid: Option<String>) -> Result<Vec<CowfileDescriptor>> {
    let mut result = vec![];

    get_builtin().iter().for_each(|chara| {
        result.push(CowfileDescriptor {
            id: chara.id.clone(),
            server_id: None,
            name: chara.name.clone(),
            author: chara.author.clone(),
            uploader_id: chara.uploader_id.clone(),
        })
    });

    Ok(result)
}

pub async fn get_cowfile(id: &str) -> Result<String> {
    let cowfiles = get_builtin_data();
    let cowdata = cowfiles
        .into_iter()
        .find(|cowfile| cowfile.id == id)
        .ok_or(anyhow!("Failed to parse base64"))?;

    Ok(decode_base64(&cowdata.data)?)
}

pub async fn cowsay(cid: &str, msg: &str) -> Result<Vec<u8>> {
    use charasay::{bubbles::BubbleType, format_character, Chara};

    let cowfile = get_cowfile(cid)
        .await
        .map_err(|err| anyhow!("{}", err.to_string()))?;
    let cowsay = format_character(msg, &Chara::Raw(cowfile), WIDTH, BubbleType::Round)
        .map_err(|err| anyhow!("{}", err.to_string()))?;
    let image = ImageBuilder::from(&cowsay)
        .set_font(FONT.to_vec())
        .set_bubble_font(FONT_BOLD.to_vec())
        .build()
        .map_err(|err| anyhow!("{}", err.to_string()))?;

    let mut bytes: Vec<u8> = Vec::new();
    image.write_to(&mut Cursor::new(&mut bytes), ImageFormat::WebP)?;
    Ok(bytes)
}
